FROM node:25-alpine

# Installer PostgreSQL client et bash
RUN apk add --no-cache postgresql-client bash openssl

# CrÃ©er le dossier de l'application
WORKDIR /app

# Copier package.json et package-lock.json
COPY package*.json ./

# Installer les dÃ©pendances
RUN npm install

# Copier le schema Prisma
COPY prisma ./prisma/

# GÃ©nÃ©rer le client Prisma
RUN npx prisma generate

# Copier tous les fichiers du backend
COPY . .

# CrÃ©er le dossier uploads
RUN mkdir -p /app/uploads

# Exposer le port
EXPOSE 3000

# Script de dÃ©marrage avec migration Prisma automatique
CMD ["sh", "-c", "\
  echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
  echo 'ğŸ•ğŸ’œ Purple Dog Backend - Starting...' && \
  echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
  echo '' && \
  echo 'â³ Waiting for PostgreSQL to be ready...' && \
  until PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c '\\q' 2>/dev/null; do \
    echo '   PostgreSQL is unavailable - sleeping...' && \
    sleep 2; \
  done && \
  echo 'âœ… PostgreSQL is ready!' && \
  echo '' && \
  echo 'ğŸ”„ Running Prisma migrations...' && \
  npx prisma migrate deploy && \
  echo 'âœ… Migrations completed!' && \
  echo '' && \
  echo 'ğŸŒ± Seeding database (if needed)...' && \
  npx prisma db seed || echo 'No seed script or seed already done' && \
  echo '' && \
  echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
  echo 'ğŸš€ Starting Express Server...' && \
  echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
  echo '' && \
  node index.js \
"]  